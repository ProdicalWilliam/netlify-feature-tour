<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Spotify ListenAlong</title>
  <!-- Favicon -->
  <link rel="icon" type="image/png" href="https://static.vecteezy.com/system/resources/previews/023/986/494/non_2x/spotify-logo-spotify-logo-transparent-spotify-icon-transparent-free-free-png.png">
  <!-- Firebase SDKs -->
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database-compat.js"></script>
  <!-- YouTube IFrame API -->
  <script async src="https://www.youtube.com/iframe_api"></script>
  <!-- Spotify Web Playback SDK (old Spotify UI remains intact) -->
  <script src="https://sdk.scdn.co/spotify-player.js"></script>
  <style>
    /* Global Styles & Animations */
    body {
      margin: 0;
      font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif;
      background: linear-gradient(135deg, #121212, #2c003e);
      color: #fff;
      overflow-x: hidden;
    }
    .fade-in { 
      animation: fadeIn 0.5s ease-in-out forwards;
      opacity: 0;
    }
    @keyframes fadeIn {
      to { opacity: 1; }
    }
    
    /* Login view - centered full screen */
    #login-wrapper {
      display: flex;
      height: 100vh;
      align-items: center;
      justify-content: center;
      background: #121212;
    }
    #auth-section {
      background: rgba(18,18,18,0.95);
      border-radius: 10px;
      padding: 30px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.9);
      text-align: center;
      width: 300px;
    }
    #auth-section input, #auth-section button {
      width: 90%;
      margin: 10px auto;
      display: block;
      padding: 12px;
      border: none;
      border-radius: 4px;
      font-size: 14px;
      outline: none;
    }
    #auth-section input {
      background: rgba(40,40,40,0.8);
      color: #fff;
      border: 1px solid rgba(29,185,84,0.7);
    }
    #auth-section button {
      background: #1db954;
      color: #fff;
      cursor: pointer;
      transition: background 0.2s ease, box-shadow 0.2s ease;
      margin-top: 15px;
    }
    #auth-section button:hover {
      background: #17a44d;
      box-shadow: 0 0 10px #1db954;
    }
    
    /* Main UI Dashboard (hidden until login) */
    #mainUI {
      display: none;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }
    header {
      background: rgba(29,185,84,0.9);
      backdrop-filter: blur(8px);
      padding: 15px 20px;
      display: flex;
      align-items: center;
      box-shadow: 0 2px 8px rgba(0,0,0,0.8);
      animation: slideDown 0.5s forwards;
    }
    @keyframes slideDown {
      from { transform: translateY(-100%); opacity: 0; }
      to { transform: translateY(0); opacity: 1; }
    }
    header img.spotify-icon {
      height: 40px;
      margin-right: 15px;
      filter: drop-shadow(0 0 5px #1db954);
    }
    header h1 {
      margin: 0;
      font-size: 28px;
      color: #fff;
      text-shadow: 0 0 8px #1db954;
    }
    .dashboard-content {
      flex: 1;
      padding: 20px;
    }
    
    /* Rooms List - Clean, organized with categories */
    #roomsContainer {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
    }
    .room-category {
      width: 100%;
      margin: 20px 0;
      text-align: center;
      font-size: 20px;
      text-transform: uppercase;
      letter-spacing: 1px;
      border-bottom: 2px solid #1db954;
      padding-bottom: 5px;
    }
    .room-list {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 15px;
      margin-top: 15px;
    }
    .room-item {
      background: rgba(40,40,40,0.8);
      padding: 10px 20px;
      border-radius: 8px;
      cursor: pointer;
      transition: transform 0.2s, background 0.2s;
    }
    .room-item:hover {
      transform: scale(1.03);
      background: rgba(29,185,84,0.7);
    }
    .room-item span {
      font-size: 16px;
      margin-left: 5px;
    }
    
    /* In-room UI (only visible inside a room) */
    #chat-room {
      display: none;
      animation: fadeIn 0.5s;
      margin-top: 20px;
    }
    .media-player input,
    .media-player button {
      width: 90%;
      margin: 10px auto;
      display: block;
    }
    /* Player containers */
    #ytplayer.invisible-player {
      width: 0;
      height: 0;
      overflow: hidden;
    }
    #audioContainer {
      text-align: center;
      margin: 15px 0;
    }
    
    /* Footer */
    footer {
      background: rgba(18,18,18,0.95);
      text-align: center;
      padding: 10px;
      font-size: 14px;
      border-top: 1px solid rgba(29,185,84,0.7);
    }
    
    /* Modal styling */
    .modal {
      position: fixed;
      top: 0; left: 0;
      width: 100%; height: 100%;
      background: rgba(0,0,0,0.7);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 100;
    }
    .modal-content {
      background: #222;
      padding: 20px;
      border-radius: 8px;
      width: 300px;
      text-align: center;
      box-shadow: 0 0 15px rgba(29,185,84,0.9);
    }
  </style>
</head>
<body>
  <!-- Login view -->
  <div id="login-wrapper" class="fade-in">
    <div id="auth-section">
      <div class="section-title">Welcome</div>
      <input type="email" id="email" placeholder="Email">
      <input type="password" id="password" placeholder="Password">
      <input type="text" id="username" placeholder="Choose a username">
      <input type="text" id="avatar" placeholder="Avatar URL (optional)">
      <button onclick="register()">Register</button>
      <button onclick="login()">Login</button>
    </div>
  </div>
  
  <!-- Main Dashboard UI -->
  <div id="mainUI" class="fade-in">
    <header>
      <img src="https://static.vecteezy.com/system/resources/previews/023/986/494/non_2x/spotify-logo-spotify-logo-transparent-spotify-icon-transparent-free-free-png.png" class="spotify-icon" alt="Spotify Icon">
      <h1>Spotify ListenAlong</h1>
    </header>
    <div class="dashboard-content">
      <!-- Rooms Section -->
      <div id="server-browser">
        <div class="section-title">Available Rooms</div>
        <div id="roomsContainer">
          <div class="room-category">Public 🔓</div>
          <div id="publicRooms" class="room-list"></div>
          <div class="room-category">Private 🔒</div>
          <div id="privateRooms" class="room-list"></div>
        </div>
        <button id="createRoomBtn" onclick="showCreateRoomModal()">➕ Create Room</button>
      </div>
      <!-- In-Room UI (only visible when inside a room) -->
      <div id="chat-room">
        <div style="display:flex; justify-content: space-between; align-items: center;">
          <h2 id="room-title">Room:</h2>
          <button id="closeRoomBtn" style="display:none;" onclick="closeRoom()">Close Room</button>
        </div>
        <div class="media-player">
          <input type="text" id="mediaLink" placeholder="Enter media URL (YouTube, Spotify, SoundCloud, Direct Audio)">
          <button onclick="updateMedia()">Update Media</button>
        </div>
        <div id="playerContainer" class="media-player">
          <!-- YouTube embed container (hidden if using audio) -->
          <div id="ytplayer"></div>
          <!-- Audio container for direct playback -->
          <div id="audioContainer"></div>
          <!-- Spotify embed container (if needed) -->
          <div id="spotifyContainer" class="spotify-player"></div>
          <!-- SoundCloud container -->
          <div id="soundcloudContainer"></div>
          <!-- Custom YouTube Controls -->
          <div id="customControls">
            <input type="range" id="seekSlider" min="0" value="0">
            <div>
              <span id="currentTimeDisplay">0:00</span> / <span id="durationDisplay">0:00</span>
            </div>
          </div>
          <!-- Spotify controls if using Web Playback SDK -->
          <div id="spotifyControls" class="spotify-controls" style="display:none;">
            <button onclick="spotifyPlayer.resume()">Play</button>
            <button onclick="spotifyPlayer.pause()">Pause</button>
          </div>
        </div>
        <div class="chat-box" id="chatBox"></div>
        <input type="text" id="chatMessage" placeholder="Type a message">
        <button onclick="sendMessage()">Send</button>
        <div id="participants"></div>
      </div>
    </div>
    <footer>@William ListenAlong 2025</footer>
  </div>
  
  <!-- Modals for Room Password and Creation -->
  <div id="passwordModal" class="modal">
    <div class="modal-content">
      <div class="section-title">Enter Room Password</div>
      <input type="password" id="modalRoomPassword" placeholder="Password">
      <button onclick="joinPrivateRoom()">Join Room</button>
    </div>
  </div>
  <div id="createRoomModal" class="modal">
    <div class="modal-content">
      <div class="section-title">Create Room</div>
      <input type="text" id="newRoomName" placeholder="Room Name">
      <input type="text" id="newRoomPassword" placeholder="Room Password (optional)">
      <select id="newRoomVisibility">
        <option value="public">Public</option>
        <option value="private">Private</option>
      </select>
      <button onclick="createRoom()">Create Room</button>
    </div>
  </div>
  
  <script>
    // Firebase configuration
    const firebaseConfig = {
      apiKey: "AIzaSyDTATBOCPb_uGYt5Trmx1EZu7doCR0WWvw",
      authDomain: "spotify-795ab.firebaseapp.com",
      projectId: "spotify-795ab",
      storageBucket: "spotify-795ab.appspot.com",
      messagingSenderId: "907464366407",
      appId: "1:907464366407:web:1c736b0a36c792ffdb1462"
    };
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.database();
    
    // Spotify OAuth & Player Setup (existing code remains)
    const spotifyClientId = "0a4506985ee8445e86f05ee777dd0c29";
    const spotifyRedirectUri = "https://dazes.org/callback.html";
    const spotifyScopes = "streaming user-read-email user-read-private";
    let spotifyPlayer = null;
    
    function getSpotifyToken() {
      const hash = window.location.hash.substring(1);
      const params = new URLSearchParams(hash);
      return params.get('access_token');
    }
    let spotifyToken = getSpotifyToken();
    if (!spotifyToken && window.location.pathname !== "/callback") {
      window.location.href = "https://accounts.spotify.com/authorize?" +
        "response_type=token" +
        "&client_id=" + encodeURIComponent(spotifyClientId) +
        "&scope=" + encodeURIComponent(spotifyScopes) +
        "&redirect_uri=" + encodeURIComponent(spotifyRedirectUri);
    }
    window.onSpotifyWebPlaybackSDKReady = () => {
      spotifyPlayer = new Spotify.Player({
        name: 'Spotify ListenAlong Player',
        getOAuthToken: cb => { cb(spotifyToken); },
        volume: 0.5
      });
      spotifyPlayer.addListener('initialization_error', ({ message }) => { console.error(message); });
      spotifyPlayer.addListener('authentication_error', ({ message }) => { console.error(message); });
      spotifyPlayer.addListener('account_error', ({ message }) => { console.error(message); });
      spotifyPlayer.addListener('playback_error', ({ message }) => { console.error(message); });
      spotifyPlayer.addListener('player_state_changed', state => { console.log(state); });
      spotifyPlayer.addListener('ready', ({ device_id }) => { console.log('Ready with Device ID', device_id); });
      spotifyPlayer.addListener('not_ready', ({ device_id }) => { console.log('Device ID has gone offline', device_id); });
      spotifyPlayer.connect();
    };
    
    // Global variables for room & media management
    const adminUID = "1119TCpma1ajWOeI250vQ2Un1dg2";
    let currentRoomId = null;
    let youtubePlayer = null;
    let mediaType = null;
    let roomCreatorUID = null;
    let currentUserProfile = { username: "", avatar: "" };
    let updateInterval = null;
    let pendingRoom = null;
    
    // ----- Authentication & Profile Setup -----
    function login() {
      const email = document.getElementById('email').value;
      const password = document.getElementById('password').value;
      auth.signInWithEmailAndPassword(email, password)
        .then(cred => loadUserProfile(cred.user))
        .catch(err => alert("Login error: " + err.message));
    }
    function register() {
      const email = document.getElementById('email').value;
      const password = document.getElementById('password').value;
      const username = document.getElementById('username').value || "Anonymous";
      const avatar = document.getElementById('avatar').value || "https://cdn4.iconfinder.com/data/icons/social-messaging-ui-color-and-shapes-3/177800/129-512.png";
      auth.createUserWithEmailAndPassword(email, password)
        .then(cred => {
          db.ref('users/' + cred.user.uid).set({ username, avatar });
          loadUserProfile(cred.user);
        })
        .catch(err => alert("Registration error: " + err.message));
    }
    function loadUserProfile(user) {
      db.ref('users/' + user.uid).once('value').then(snapshot => {
        const data = snapshot.val() || {};
        currentUserProfile.username = data.username || "Anonymous";
        currentUserProfile.avatar = data.avatar || "https://cdn4.iconfinder.com/data/icons/social-messaging-ui-color-and-shapes-3/177800/129-512.png";
        document.getElementById('login-wrapper').style.display = 'none';
        document.getElementById('mainUI').style.display = 'block';
        showServerBrowser();
      });
    }
    
    // ----- Server Browser: List Rooms with Categories & Animations -----
    function showServerBrowser() {
      db.ref('rooms').on('value', snapshot => {
        const rooms = snapshot.val();
        const publicRoomsEl = document.getElementById('publicRooms');
        const privateRoomsEl = document.getElementById('privateRooms');
        publicRoomsEl.innerHTML = "";
        privateRoomsEl.innerHTML = "";
        for (let roomId in rooms) {
          const room = rooms[roomId];
          const roomEl = document.createElement('div');
          roomEl.classList.add('room-item', 'fade-in');
          // Emoji based on visibility
          const visibilityEmoji = room.visibility === "private" ? "🔒" : "🔓";
          roomEl.innerHTML = `<strong>${room.name}</strong> <span>${visibilityEmoji}</span>`;
          roomEl.onclick = () => {
            if (room.password) {
              pendingRoom = { id: roomId, room };
              document.getElementById('passwordModal').style.display = 'flex';
            } else {
              joinRoomById(roomId);
            }
          };
          if (room.visibility === "private") {
            privateRoomsEl.appendChild(roomEl);
          } else {
            publicRoomsEl.appendChild(roomEl);
          }
        }
      });
    }
    function joinPrivateRoom() {
      const enteredPassword = document.getElementById('modalRoomPassword').value;
      if (pendingRoom && pendingRoom.room.password === enteredPassword) {
        joinRoomById(pendingRoom.id);
        pendingRoom = null;
        document.getElementById('passwordModal').style.display = 'none';
        document.getElementById('modalRoomPassword').value = "";
      } else {
        alert("Incorrect password!");
      }
    }
    function showCreateRoomModal() {
      document.getElementById('createRoomModal').style.display = 'flex';
    }
    function createRoom() {
      const roomName = document.getElementById('newRoomName').value;
      const roomPassword = document.getElementById('newRoomPassword').value;
      const roomVisibility = document.getElementById('newRoomVisibility').value;
      if (!roomName) {
        alert("Please enter a room name.");
        return;
      }
      const user = auth.currentUser;
      const roomData = {
        name: roomName,
        password: roomPassword || null,
        visibility: roomVisibility,
        mediaLink: "",
        mediaTimestamp: 0,
        createdAt: firebase.database.ServerValue.TIMESTAMP,
        creator: user.uid,
        banned: {}
      };
      const newRoomRef = db.ref('rooms').push();
      newRoomRef.set(roomData, error => {
        if (error) {
          alert('Error creating room: ' + error.message);
        } else {
          document.getElementById('createRoomModal').style.display = 'none';
          joinRoomById(newRoomRef.key);
        }
      });
    }
    
    // ----- Join Room & In-Room UI -----
    function joinRoomById(roomId) {
      db.ref('rooms/' + roomId + '/banned').once('value').then(snapshot => {
        const banned = snapshot.val() || {};
        if (banned[auth.currentUser.uid]) {
          alert("You have been banned from this room.");
          return;
        }
        document.getElementById('server-browser').style.display = 'none';
        document.getElementById('chat-room').style.display = 'block';
        document.getElementById('room-title').innerText = "Room: " + roomId;
        db.ref('rooms/' + roomId).once('value').then(snapshot => {
          const room = snapshot.val();
          roomCreatorUID = room.creator;
          if (auth.currentUser.uid === roomCreatorUID || auth.currentUser.uid === adminUID) {
            document.getElementById('closeRoomBtn').style.display = 'block';
            document.getElementById('customControls').style.display = 'block';
            document.getElementById('spotifyControls').style.display = 'flex';
          }
        });
        currentRoomId = roomId;
        const uid = auth.currentUser.uid;
        db.ref('rooms/' + roomId + '/participants/' + uid).set({
          username: currentUserProfile.username,
          avatar: currentUserProfile.avatar
        });
        db.ref('rooms/' + roomId + '/participants/' + uid).onDisconnect().remove();
        db.ref('rooms/' + roomId + '/mediaLink').on('value', snapshot => {
          const link = snapshot.val();
          if (link) {
            mediaType = detectMediaType(link);
            loadMedia(link);
          }
        });
        db.ref('rooms/' + roomId + '/mediaTimestamp').on('value', snapshot => {
          const ts = snapshot.val();
          if (mediaType === "youtube" && youtubePlayer && auth.currentUser.uid !== roomCreatorUID) {
            const currentTime = youtubePlayer.getCurrentTime();
            if (Math.abs(currentTime - ts / 1000) > 1) {
              youtubePlayer.seekTo(ts / 1000, true);
            }
          }
        });
        db.ref('rooms/' + roomId + '/chat').on('child_added', snapshot => {
          displayMessage(snapshot.val());
        });
        db.ref('rooms/' + roomId + '/participants').on('value', snapshot => {
          updateParticipants(snapshot.val());
        });
      });
    }
    function closeRoom() {
      if (auth.currentUser.uid !== roomCreatorUID && auth.currentUser.uid !== adminUID) return;
      if (confirm("Are you sure you want to close this room?")) {
        db.ref('rooms/' + currentRoomId).remove();
        alert("Room closed.");
        location.reload();
      }
    }
    
    // ----- Media Handling -----
    // Improved detectMediaType to correctly match audio file extensions even with query parameters.
    function detectMediaType(link) {
      if (link.match(/\.(mp3|wav|ogg|mov)(\?.*)?$/i)) {
        return "audio";
      } else if (link.includes("youtube.com") || link.includes("youtu.be")) {
        return "youtube";
      } else if (link.includes("open.spotify.com/track")) {
        return "spotify";
      } else if (link.includes("soundcloud.com")) {
        return "soundcloud";
      }
      return "other";
    }
    function loadMedia(link) {
      // Clear any previous media
      document.getElementById('ytplayer').innerHTML = "";
      document.getElementById('audioContainer').innerHTML = "";
      document.getElementById('spotifyContainer').innerHTML = "";
      document.getElementById('soundcloudContainer').innerHTML = "";
      
      // Allow multiple updates by clearing the mediaLink field after updating.
      document.getElementById('mediaLink').value = "";
      
      if (mediaType === "youtube") {
        const ytContainer = document.getElementById('ytplayer');
        ytContainer.classList.add('invisible-player');
        onYouTubeIframeAPIReady(link);
      } else if (mediaType === "spotify") {
        fetchSpotifyTrackInfo(link)
          .then(query => { searchYouTubeAndLoad(query); })
          .catch(e => { console.error("Spotify track info error:", e); });
      } else if (mediaType === "audio") {
        // Create a standard HTML5 audio player with controls.
        const audio = new Audio(link);
        audio.id = "directAudioPlayer";
        audio.controls = true;
        audio.style.width = "100%";
        document.getElementById('audioContainer').appendChild(audio);
        audio.play();
        audio.addEventListener('timeupdate', function() {
          if (auth.currentUser.uid === roomCreatorUID) {
            db.ref('rooms/' + currentRoomId).update({ mediaTimestamp: Math.floor(audio.currentTime * 1000) });
          }
        });
        db.ref('rooms/' + currentRoomId + '/mediaTimestamp').on('value', snapshot => {
          const ts = snapshot.val();
          if (audio && Math.abs(audio.currentTime - ts / 1000) > 1) {
            audio.currentTime = ts / 1000;
          }
        });
      } else if (mediaType === "soundcloud") {
        const embedUrl = "https://w.soundcloud.com/player/?url=" + encodeURIComponent(link) + "&auto_play=true";
        document.getElementById('soundcloudContainer').innerHTML = `<iframe width="100%" height="166" scrolling="no" frameborder="no" allow="autoplay" src="${embedUrl}"></iframe>`;
      } else {
        document.getElementById('playerContainer').innerHTML = `<p>Unsupported media type</p>`;
      }
    }
    function onYouTubeIframeAPIReady(link) {
      let videoId = "";
      try {
        if (link.includes("youtube.com")) {
          const urlParams = new URLSearchParams(new URL(link).search);
          videoId = urlParams.get('v');
        } else if (link.includes("youtu.be")) {
          videoId = link.split('/').pop();
        }
        youtubePlayer = new YT.Player('ytplayer', {
          height: '0',
          width: '0',
          videoId: videoId,
          playerVars: {
            autoplay: 1,
            controls: 0,
            modestbranding: 1
          },
          events: {
            'onReady': onPlayerReady,
            'onStateChange': onPlayerStateChange
          }
        });
      } catch (e) {
        console.error("Error loading YouTube video", e);
      }
    }
    function onPlayerReady(event) {
      db.ref('rooms/' + currentRoomId + '/mediaTimestamp').once('value').then(snapshot => {
        const ts = snapshot.val();
        if (ts && auth.currentUser.uid !== roomCreatorUID) {
          event.target.seekTo(ts / 1000, true);
        }
      });
      if (auth.currentUser.uid === roomCreatorUID) {
        setupCustomControls();
        if (updateInterval) clearInterval(updateInterval);
        updateInterval = setInterval(() => {
          if (youtubePlayer && youtubePlayer.getPlayerState() === YT.PlayerState.PLAYING) {
            const currentTime = youtubePlayer.getCurrentTime();
            db.ref('rooms/' + currentRoomId).update({ mediaTimestamp: Math.floor(currentTime * 1000) });
            updateSlider();
          }
        }, 1000);
      }
    }
    function onPlayerStateChange(event) { }
    function setupCustomControls() {
      const slider = document.getElementById('seekSlider');
      const durationInterval = setInterval(() => {
        const duration = youtubePlayer.getDuration();
        if (duration > 0) {
          slider.max = duration;
          document.getElementById('durationDisplay').innerText = formatTime(duration);
          clearInterval(durationInterval);
        }
      }, 500);
      slider.addEventListener('input', function() {
        document.getElementById('currentTimeDisplay').innerText = formatTime(slider.value);
      });
      slider.addEventListener('change', function() {
        youtubePlayer.seekTo(slider.value, true);
        db.ref('rooms/' + currentRoomId).update({ mediaTimestamp: Math.floor(slider.value * 1000) });
      });
    }
    function updateSlider() {
      const slider = document.getElementById('seekSlider');
      if (slider && youtubePlayer && youtubePlayer.getDuration() > 0) {
        slider.value = youtubePlayer.getCurrentTime();
        document.getElementById('currentTimeDisplay').innerText = formatTime(youtubePlayer.getCurrentTime());
      }
    }
    function formatTime(seconds) {
      seconds = Math.floor(seconds);
      let minutes = Math.floor(seconds / 60);
      seconds = seconds % 60;
      return minutes + ":" + (seconds < 10 ? "0" + seconds : seconds);
    }
    function updateMedia() {
      if (auth.currentUser.uid !== roomCreatorUID && auth.currentUser.uid !== adminUID) {
        alert("Only the room creator or admin can change the media.");
        return;
      }
      const link = document.getElementById('mediaLink').value;
      db.ref('rooms/' + currentRoomId).update({
        mediaLink: link,
        mediaTimestamp: 0
      });
    }
    
    // ----- Spotify Integration: Better YouTube Search -----
    function fetchSpotifyTrackInfo(link) {
      return new Promise((resolve, reject) => {
        try {
          const trackId = link.split("track/")[1].split("?")[0];
          // Here you would normally call Spotify's API for track details.
          // For demonstration, we simulate with a more descriptive query.
          // (Replace this with a real API call and parsing.)
          const dummyQuery = "Accurate Song Title - Artist Name";
          resolve(dummyQuery);
        } catch(e) {
          reject(e);
        }
      });
    }
    function searchYouTubeAndLoad(query) {
      console.log("Searching YouTube for:", query);
      // Improved simulated search:
      // In production, use the YouTube Data API with your API key.
      // Here we simulate a search by appending the query to a YouTube search URL,
      // then (for demo) we choose a “best match” video.
      // For instance, we simulate if the query contains "Accurate" then return a known video ID.
      let videoId = "tIwYFcelvdw"; // default fallback
      if(query.toLowerCase().includes("accurate")){
        videoId = "tIwYFcelvdw"; // Replace with an actual accurate match.
      }
      const accurateYouTubeLink = "https://www.youtube.com/watch?v=" + videoId;
      mediaType = "youtube";
      loadMedia(accurateYouTubeLink);
    }
    
    // ----- Chat Functions -----
    function sendMessage() {
      const message = document.getElementById('chatMessage').value;
      if (!message.trim() || !currentRoomId) return;
      const messageData = {
        text: message,
        user: currentUserProfile.username,
        avatar: currentUserProfile.avatar,
        timestamp: firebase.database.ServerValue.TIMESTAMP
      };
      db.ref('rooms/' + currentRoomId + '/chat').push(messageData);
      document.getElementById('chatMessage').value = "";
    }
    function displayMessage(messageData) {
      const chatBox = document.getElementById('chatBox');
      const div = document.createElement('div');
      div.classList.add('message', 'fade-in');
      div.innerHTML = `<strong>${messageData.user}:</strong> ${messageData.text}`;
      chatBox.appendChild(div);
      chatBox.scrollTop = chatBox.scrollHeight;
    }
    
    // ----- Participant List & Admin Controls -----
    function updateParticipants(participants) {
      const container = document.getElementById('participants');
      container.innerHTML = "";
      if (participants) {
        Object.keys(participants).forEach(uid => {
          const p = participants[uid];
          const div = document.createElement('div');
          div.classList.add('participant', 'fade-in');
          if (uid === roomCreatorUID) div.classList.add('creator');
          div.innerHTML = `<img src="${p.avatar}" alt="${p.username}"><div>${p.username}</div>`;
          if ((auth.currentUser.uid === roomCreatorUID || auth.currentUser.uid === adminUID) && uid !== auth.currentUser.uid) {
            const controls = document.createElement('div');
            controls.classList.add('control-buttons');
            const kickBtn = document.createElement('button');
            kickBtn.innerText = "Kick";
            kickBtn.onclick = () => kickParticipant(uid);
            const banBtn = document.createElement('button');
            banBtn.innerText = "Ban";
            banBtn.onclick = () => banParticipant(uid);
            controls.appendChild(kickBtn);
            controls.appendChild(banBtn);
            div.appendChild(controls);
          }
          container.appendChild(div);
        });
      }
    }
    function kickParticipant(uid) {
      if (confirm("Are you sure you want to kick this participant?")) {
        db.ref('rooms/' + currentRoomId + '/participants/' + uid).remove();
      }
    }
    function banParticipant(uid) {
      if (confirm("Are you sure you want to ban this participant? They will not be able to rejoin.")) {
        db.ref('rooms/' + currentRoomId + '/participants/' + uid).remove();
        db.ref('rooms/' + currentRoomId + '/banned/' + uid).set(true);
      }
    }
  </script>
</body>
</html>
