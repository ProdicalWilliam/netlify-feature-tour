<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Spotify ListenAlong</title>
  <!-- Firebase SDKs -->
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database-compat.js"></script>
  <!-- YouTube IFrame API for media sync -->
  <script async src="https://www.youtube.com/iframe_api"></script>
  <style>
    /* Global Styles */
    body {
      margin: 0;
      font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif;
      background: linear-gradient(135deg, #121212, #2c003e);
      color: #fff;
      overflow-x: hidden;
    }
    header {
      background: rgba(29, 185, 84, 0.9);
      backdrop-filter: blur(8px);
      padding: 15px 20px;
      display: flex;
      align-items: center;
      box-shadow: 0 2px 5px rgba(0,0,0,0.5);
    }
    header img.spotify-icon {
      height: 40px;
      margin-right: 15px;
    }
    header h1 {
      margin: 0;
      font-size: 28px;
      color: #fff;
    }
    .container {
      width: 90%;
      max-width: 900px;
      margin: 30px auto;
      background: rgba(18, 18, 18, 0.9);
      border-radius: 10px;
      padding: 20px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.7);
      backdrop-filter: blur(5px);
    }
    /* Button & Input Styles */
    input, button, select {
      padding: 10px;
      margin: 8px 0;
      border: none;
      border-radius: 4px;
      font-size: 14px;
      outline: none;
    }
    input {
      width: 100%;
      background: rgba(40, 40, 40, 0.8);
      color: #fff;
    }
    button {
      background: #1db954;
      color: #fff;
      cursor: pointer;
      transition: background 0.2s ease;
    }
    button:hover {
      background: #17a44d;
    }
    select {
      background: rgba(40, 40, 40, 0.8);
      color: #fff;
      width: 100%;
    }
    /* Sections */
    .section {
      margin-bottom: 20px;
      padding: 10px 0;
    }
    .section-title {
      font-size: 20px;
      margin-bottom: 10px;
      border-bottom: 1px solid #1db954;
      padding-bottom: 5px;
    }
    /* Auth Page */
    #auth-section {
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    #auth-section input, #auth-section button {
      max-width: 350px;
    }
    /* Server Browser */
    #server-browser {
      display: none;
    }
    .room-list {
      list-style: none;
      padding: 0;
      margin: 0;
    }
    .room-item {
      background: rgba(40, 40, 40, 0.8);
      margin: 10px 0;
      padding: 12px;
      border-radius: 6px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      cursor: pointer;
      transition: background 0.2s;
    }
    .room-item:hover {
      background: rgba(29, 185, 84, 0.7);
    }
    .room-details {
      flex: 1;
    }
    .room-details h3 {
      margin: 0;
      font-size: 18px;
      color: #1db954;
    }
    .room-details p {
      margin: 4px 0 0;
      font-size: 14px;
      color: #ccc;
    }
    /* Modal for Private Room Password */
    .modal {
      position: fixed;
      top: 0; left: 0;
      width: 100%; height: 100%;
      background: rgba(0,0,0,0.7);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 100;
    }
    .modal-content {
      background: #222;
      padding: 20px;
      border-radius: 8px;
      width: 300px;
      text-align: center;
    }
    .modal-content input {
      width: 90%;
    }
    .modal-content button {
      margin-top: 10px;
      width: 90%;
    }
    /* Chat & Media Room Styles remain similar */
    #chat-room {
      display: none;
    }
    .media-player {
      margin: 15px 0;
      text-align: center;
    }
    #customControls {
      margin-top: 10px;
      display: none;
      color: #1db954;
    }
    #seekSlider {
      width: 100%;
    }
    .chat-box {
      border: 1px solid #282828;
      background: #121212;
      padding: 10px;
      height: 200px;
      overflow-y: auto;
      border-radius: 4px;
      margin-bottom: 10px;
    }
    .message {
      margin-bottom: 10px;
      padding: 5px;
      border-bottom: 1px solid #282828;
    }
    #participants {
      display: flex;
      flex-wrap: wrap;
      border-top: 1px solid #282828;
      padding-top: 10px;
    }
    .participant {
      margin: 5px;
      text-align: center;
      position: relative;
    }
    .participant img {
      width: 50px;
      height: 50px;
      border-radius: 50%;
      border: 2px solid transparent;
    }
    /* Crown overlay for room creator: centered at top */
    .creator::after {
      content: "";
      position: absolute;
      top: -10px;
      left: 50%;
      transform: translateX(-50%);
      width: 35px;
      height: 35px;
      background: url('https://png.pngtree.com/png-vector/20220517/ourmid/pngtree-golden-crown-isolated-on-white-background-png-image_4656900.png') no-repeat center center;
      background-size: contain;
      pointer-events: none;
    }
  </style>
</head>
<body>
  <header>
    <img src="https://static.vecteezy.com/system/resources/previews/023/986/494/non_2x/spotify-logo-spotify-logo-transparent-spotify-icon-transparent-free-free-png.png" class="spotify-icon" alt="Spotify Icon">
    <h1>Spotify ListenAlong</h1>
  </header>
  <div class="container">
    <!-- Authentication Section -->
    <div id="auth-section" class="section">
      <div class="section-title">Welcome</div>
      <input type="email" id="email" placeholder="Email">
      <input type="password" id="password" placeholder="Password">
      <input type="text" id="username" placeholder="Choose a username">
      <input type="text" id="avatar" placeholder="Avatar URL (optional)">
      <button onclick="register()">Register</button>
      <button onclick="login()">Login</button>
    </div>

    <!-- Server Browser Section -->
    <div id="server-browser" class="section">
      <div class="section-title">Available Rooms</div>
      <ul id="roomList" class="room-list"></ul>
    </div>

    <!-- Chat & Media Room Section -->
    <div id="chat-room" class="section">
      <div style="display:flex; justify-content: space-between; align-items: center;">
        <h2 id="room-title">Room:</h2>
        <button id="closeRoomBtn" style="display:none;" onclick="closeRoom()">Close Room</button>
      </div>
      <div class="media-player">
        <input type="text" id="mediaLink" placeholder="Enter media URL (YouTube, Spotify, SoundCloud)">
        <button onclick="updateMedia()">Update Media</button>
      </div>
      <div id="playerContainer" class="media-player">
        <!-- For YouTube video -->
        <div id="ytplayer"></div>
        <div id="customControls">
          <input type="range" id="seekSlider" min="0" value="0">
          <div>
            <span id="currentTimeDisplay">0:00</span> / <span id="durationDisplay">0:00</span>
          </div>
        </div>
      </div>
      <div class="chat-box" id="chatBox"></div>
      <input type="text" id="chatMessage" placeholder="Type a message">
      <button onclick="sendMessage()">Send</button>
      <div id="participants"></div>
    </div>
  </div>

  <!-- Modal for entering private room password -->
  <div id="passwordModal" class="modal">
    <div class="modal-content">
      <div class="section-title">Enter Room Password</div>
      <input type="password" id="modalRoomPassword" placeholder="Password">
      <button onclick="joinPrivateRoom()">Join Room</button>
    </div>
  </div>

  <script>
    // Firebase configuration
    const firebaseConfig = {
      apiKey: "AIzaSyDTATBOCPb_uGYt5Trmx1EZu7doCR0WWvw",
      authDomain: "spotify-795ab.firebaseapp.com",
      projectId: "spotify-795ab",
      storageBucket: "spotify-795ab.appspot.com",
      messagingSenderId: "907464366407",
      appId: "1:907464366407:web:1c736b0a36c792ffdb1462"
    };
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.database();

    // Global variables
    let currentRoomId = null;
    let youtubePlayer = null;
    let mediaType = null; // "youtube", "spotify", "soundcloud", or "other"
    let roomCreatorUID = null;
    let currentUserProfile = { username: "", avatar: "" };
    let updateInterval = null;
    let pendingRoom = null; // temporary storage for a room user wants to join (private)

    // ----- Authentication & Profile Setup -----
    function login() {
      const email = document.getElementById('email').value;
      const password = document.getElementById('password').value;
      auth.signInWithEmailAndPassword(email, password)
        .then(cred => loadUserProfile(cred.user))
        .catch(err => alert("Login error: " + err.message));
    }

    function register() {
      const email = document.getElementById('email').value;
      const password = document.getElementById('password').value;
      const username = document.getElementById('username').value || "Anonymous";
      const avatar = document.getElementById('avatar').value || "https://cdn4.iconfinder.com/data/icons/social-messaging-ui-color-and-shapes-3/177800/129-512.png";
      auth.createUserWithEmailAndPassword(email, password)
        .then(cred => {
          db.ref('users/' + cred.user.uid).set({ username, avatar });
          loadUserProfile(cred.user);
        })
        .catch(err => alert("Registration error: " + err.message));
    }

    function loadUserProfile(user) {
      db.ref('users/' + user.uid).once('value').then(snapshot => {
        const data = snapshot.val() || {};
        currentUserProfile.username = data.username || "Anonymous";
        currentUserProfile.avatar = data.avatar || "https://cdn4.iconfinder.com/data/icons/social-messaging-ui-color-and-shapes-3/177800/129-512.png";
        document.getElementById('auth-section').style.display = 'none';
        showServerBrowser();
      });
    }

    // ----- Server Browser: List Rooms -----
    function showServerBrowser() {
      document.getElementById('server-browser').style.display = 'block';
      // Listen for available rooms (public and private)
      db.ref('rooms').on('value', snapshot => {
        const rooms = snapshot.val();
        const roomList = document.getElementById('roomList');
        roomList.innerHTML = "";
        for (let roomId in rooms) {
          const room = rooms[roomId];
          const li = document.createElement('li');
          li.classList.add('room-item');
          li.onclick = () => {
            // If room is private, ask for password
            if (room.password) {
              pendingRoom = { id: roomId, room };
              document.getElementById('passwordModal').style.display = 'flex';
            } else {
              joinRoomById(roomId);
            }
          };
          li.innerHTML = `
            <div class="room-details">
              <h3>${room.name}</h3>
              <p>${room.visibility.charAt(0).toUpperCase() + room.visibility.slice(1)} Room</p>
            </div>
            <div>${room.password ? '🔒' : '🔓'}</div>
          `;
          roomList.appendChild(li);
        }
      });
    }

    // Called when user submits password for a private room
    function joinPrivateRoom() {
      const enteredPassword = document.getElementById('modalRoomPassword').value;
      if (pendingRoom && pendingRoom.room.password === enteredPassword) {
        joinRoomById(pendingRoom.id);
        pendingRoom = null;
        document.getElementById('passwordModal').style.display = 'none';
        document.getElementById('modalRoomPassword').value = "";
      } else {
        alert("Incorrect password!");
      }
    }

    // ----- Room Creation / Join / Close -----
    function createRoom() {
      // (You could add a dedicated form for room creation within the browser view)
      const roomName = prompt("Enter room name:");
      if (!roomName) return;
      const roomPassword = prompt("Set a password for this room (leave blank for public):");
      const roomVisibility = roomPassword ? "private" : "public";
      const user = auth.currentUser;
      const roomData = {
        name: roomName,
        password: roomPassword || null,
        visibility: roomVisibility,
        mediaLink: "",
        mediaTimestamp: 0,
        createdAt: firebase.database.ServerValue.TIMESTAMP,
        creator: user.uid
      };
      const newRoomRef = db.ref('rooms').push();
      newRoomRef.set(roomData, error => {
        if (error) {
          alert('Error creating room: ' + error.message);
        } else {
          joinRoomById(newRoomRef.key);
        }
      });
    }

    function joinRoomById(roomId) {
      document.getElementById('server-browser').style.display = 'none';
      document.getElementById('chat-room').style.display = 'block';
      document.getElementById('room-title').innerText = "Room: " + roomId;
      // Fetch room details to know the creator
      db.ref('rooms/' + roomId).once('value').then(snapshot => {
        const room = snapshot.val();
        roomCreatorUID = room.creator;
        // Show close button only for creator
        if (auth.currentUser.uid === roomCreatorUID) {
          document.getElementById('closeRoomBtn').style.display = 'block';
        }
      });
      currentRoomId = roomId;

      // Add user to participants list
      const uid = auth.currentUser.uid;
      db.ref('rooms/' + roomId + '/participants/' + uid).set({
        username: currentUserProfile.username,
        avatar: currentUserProfile.avatar
      });
      db.ref('rooms/' + roomId + '/participants/' + uid).onDisconnect().remove();

      // Listen for media link updates for sync
      db.ref('rooms/' + roomId + '/mediaLink').on('value', snapshot => {
        const link = snapshot.val();
        if (link) {
          mediaType = detectMediaType(link);
          loadMedia(link);
        }
      });
      // Listen for media timestamp updates (for YouTube syncing)
      db.ref('rooms/' + roomId + '/mediaTimestamp').on('value', snapshot => {
        const ts = snapshot.val();
        if (mediaType === "youtube" && youtubePlayer && auth.currentUser.uid !== roomCreatorUID) {
          const currentTime = youtubePlayer.getCurrentTime();
          if (Math.abs(currentTime - ts/1000) > 1) {
            youtubePlayer.seekTo(ts / 1000, true);
          }
        }
      });
      // Listen for chat messages
      db.ref('rooms/' + roomId + '/chat').on('child_added', snapshot => {
        displayMessage(snapshot.val());
      });
      // Listen for participant list changes
      db.ref('rooms/' + roomId + '/participants').on('value', snapshot => {
        updateParticipants(snapshot.val());
      });
    }

    function closeRoom() {
      if (auth.currentUser.uid !== roomCreatorUID) return;
      if (confirm("Are you sure you want to close this room?")) {
        db.ref('rooms/' + currentRoomId).remove();
        alert("Room closed.");
        location.reload();
      }
    }

    // ----- Media Handling & Sync -----
    function detectMediaType(link) {
      if (link.includes("youtube.com") || link.includes("youtu.be")) {
        return "youtube";
      } else if (link.includes("open.spotify.com/track")) {
        return "spotify";
      } else if (link.includes("soundcloud.com")) {
        return "soundcloud";
      }
      return "other";
    }

    function loadMedia(link) {
      if (mediaType === "youtube") {
        document.getElementById('ytplayer').innerHTML = "";
        if (typeof onYouTubeIframeAPIReady === 'function') {
          onYouTubeIframeAPIReady(link);
        }
      } else if (mediaType === "spotify") {
        const trackId = link.split("track/")[1].split("?")[0];
        const embedUrl = "https://open.spotify.com/embed/track/" + trackId;
        document.getElementById('playerContainer').innerHTML = `<iframe src="${embedUrl}" width="300" height="380" frameborder="0" allowtransparency="true" allow="encrypted-media"></iframe>`;
      } else if (mediaType === "soundcloud") {
        const embedUrl = "https://w.soundcloud.com/player/?url=" + encodeURIComponent(link) + "&auto_play=true";
        document.getElementById('playerContainer').innerHTML = `<iframe width="100%" height="166" scrolling="no" frameborder="no" allow="autoplay" src="${embedUrl}"></iframe>`;
      } else {
        document.getElementById('playerContainer').innerHTML = `<p>Unsupported media type</p>`;
      }
    }

    function onYouTubeIframeAPIReady(link) {
      let videoId = "";
      try {
        if (link.includes("youtube.com")) {
          const urlParams = new URLSearchParams(new URL(link).search);
          videoId = urlParams.get('v');
        } else if (link.includes("youtu.be")) {
          videoId = link.split('/').pop();
        }
        youtubePlayer = new YT.Player('ytplayer', {
          height: '315',
          width: '560',
          videoId: videoId,
          playerVars: {
            autoplay: 1,
            controls: 0,
            modestbranding: 1
          },
          events: {
            'onReady': onPlayerReady,
            'onStateChange': onPlayerStateChange
          }
        });
      } catch (e) {
        console.error("Error loading YouTube video", e);
      }
    }

    function onPlayerReady(event) {
      db.ref('rooms/' + currentRoomId + '/mediaTimestamp').once('value').then(snapshot => {
        const ts = snapshot.val();
        if (ts && auth.currentUser.uid !== roomCreatorUID) {
          event.target.seekTo(ts / 1000, true);
        }
      });
      if (auth.currentUser.uid === roomCreatorUID) {
        setupCustomControls();
        if (updateInterval) clearInterval(updateInterval);
        updateInterval = setInterval(() => {
          if (youtubePlayer && youtubePlayer.getPlayerState() === YT.PlayerState.PLAYING) {
            const currentTime = youtubePlayer.getCurrentTime();
            db.ref('rooms/' + currentRoomId).update({ mediaTimestamp: Math.floor(currentTime * 1000) });
            updateSlider();
          }
        }, 1000);
      }
    }

    function onPlayerStateChange(event) {
      // Handled by interval syncing for room creator
    }

    function setupCustomControls() {
      const slider = document.getElementById('seekSlider');
      const durationInterval = setInterval(() => {
        const duration = youtubePlayer.getDuration();
        if (duration > 0) {
          slider.max = duration;
          document.getElementById('durationDisplay').innerText = formatTime(duration);
          clearInterval(durationInterval);
        }
      }, 500);
      slider.addEventListener('input', function() {
        document.getElementById('currentTimeDisplay').innerText = formatTime(slider.value);
      });
      slider.addEventListener('change', function() {
        youtubePlayer.seekTo(slider.value, true);
        db.ref('rooms/' + currentRoomId).update({ mediaTimestamp: Math.floor(slider.value * 1000) });
      });
    }

    function updateSlider() {
      const slider = document.getElementById('seekSlider');
      if (slider && youtubePlayer && youtubePlayer.getDuration() > 0) {
        slider.value = youtubePlayer.getCurrentTime();
        document.getElementById('currentTimeDisplay').innerText = formatTime(youtubePlayer.getCurrentTime());
      }
    }

    function formatTime(seconds) {
      seconds = Math.floor(seconds);
      let minutes = Math.floor(seconds / 60);
      seconds = seconds % 60;
      return minutes + ":" + (seconds < 10 ? "0" + seconds : seconds);
    }

    function updateMedia() {
      if (auth.currentUser.uid !== roomCreatorUID) {
        alert("Only the room creator can change the media.");
        return;
      }
      const link = document.getElementById('mediaLink').value;
      db.ref('rooms/' + currentRoomId).update({
        mediaLink: link,
        mediaTimestamp: 0
      });
    }

    // ----- Chat Functions -----
    function sendMessage() {
      const message = document.getElementById('chatMessage').value;
      if (!message.trim() || !currentRoomId) return;
      const messageData = {
        text: message,
        user: currentUserProfile.username,
        avatar: currentUserProfile.avatar,
        timestamp: firebase.database.ServerValue.TIMESTAMP
      };
      db.ref('rooms/' + currentRoomId + '/chat').push(messageData);
      document.getElementById('chatMessage').value = "";
    }

    function displayMessage(messageData) {
      const chatBox = document.getElementById('chatBox');
      const div = document.createElement('div');
      div.classList.add('message');
      div.innerHTML = `<strong>${messageData.user}:</strong> ${messageData.text}`;
      chatBox.appendChild(div);
      chatBox.scrollTop = chatBox.scrollHeight;
    }

    // ----- Participant List -----
    function updateParticipants(participants) {
      const container = document.getElementById('participants');
      container.innerHTML = "";
      if (participants) {
        Object.keys(participants).forEach(uid => {
          const p = participants[uid];
          const div = document.createElement('div');
          div.classList.add('participant');
          if (uid === roomCreatorUID) div.classList.add('creator');
          div.innerHTML = `
            <img src="${p.avatar}" alt="${p.username}">
            <div>${p.username}</div>
          `;
          container.appendChild(div);
        });
      }
    }
  </script>
</body>
</html>
